name: Sync Wiki

on:
  push:
    branches: [main]
    paths:
      - 'docs/wiki/**'

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    env:
      GH_REPO: ${{ github.repository }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync docs to wiki
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone wiki repo
          wiki_url="https://x-access-token:${GITHUB_TOKEN}@github.com/${GH_REPO}.wiki.git"
          git clone "$wiki_url" wiki-checkout 2>/dev/null || {
            echo "Wiki not initialized. Create at least one page in the GitHub Wiki tab first."
            exit 1
          }

          # Clear existing wiki content (except .git)
          find wiki-checkout -maxdepth 1 -not -name '.git' -not -name 'wiki-checkout' -not -path 'wiki-checkout' -delete 2>/dev/null || true

          # Copy docs into wiki
          cp docs/wiki/*.md wiki-checkout/

          # Rename README.md to Home.md (GitHub Wiki landing page)
          if [ -f wiki-checkout/README.md ]; then
            mv wiki-checkout/README.md wiki-checkout/Home.md
            # Fix links: remove .md extension for wiki compatibility
            sed -i 's/(\([a-z-]*\)\.md)/(\1)/g' wiki-checkout/Home.md
          fi

          # Generate _Sidebar.md for wiki navigation
          cat > wiki-checkout/_Sidebar.md << 'SIDEBAR'
**[Home](Home)**

---

**Getting Started**
- [Installation](installation)
- [Getting Started](getting-started)
- [Configuration](configuration)

**Features**
- [Apps](apps)
- [Reverse Proxy](reverse-proxy)
- [Navigation](navigation)
- [Themes](themes)
- [Keyboard Shortcuts](keyboard-shortcuts)
- [Health Monitoring](health-monitoring)
- [Icons](icons)

**Security**
- [Authentication](authentication)
- [TLS & HTTPS](tls-and-gateway)

**Operations**
- [Deployment](deployment)
- [Troubleshooting](troubleshooting)
- [API Reference](api)
SIDEBAR

          # Fix inter-page links in all wiki files (remove .md extension)
          for f in wiki-checkout/*.md; do
            sed -i 's/(\([a-z-]*\)\.md)/(\1)/g' "$f"
          done

          # Push if there are changes
          cd wiki-checkout
          git add -A
          if git diff --cached --quiet; then
            echo "No wiki changes to push."
          else
            git commit -m "Sync wiki from docs/wiki"
            git push
            echo "Wiki updated successfully."
          fi
